name: æ‰“åŒ…
on: 
  push:
    branches: [master]

permissions:
  contents: write

jobs:
  build-windows:
    name: é€‰æ‹©æœ€æ–°windows
    runs-on: windows-2022

    steps:
    - name: è¯»å–ä»“åº“å†…å®¹
      uses: actions/checkout@v4

    - name: æ‰“å°å½“å‰ç›®å½•
      run: (Get-Location).Path

        # - run: git clone https://github.com/Microsoft/vcpkg.git
        # - run: ./vcpkg/bootstrap-vcpkg.bat
        # - run: ./vcpkg/vcpkg.exe install --x-manifest-root="./"
    - name: å®‰è£…ä¸Žå¯¼å‡º
      run: |
        vcpkg.exe install --x-manifest-root="./"
        vcpkg.exe export --raw --output-dir=./ --output=export --x-all-installed
        Get-ChildItem
    # - name: éƒ¨ç½²ðŸš€
    #   uses: JamesIves/github-pages-deploy-action@v4
    #   with: 
    #     branch: gh-pages
    #     folder: build
    - name: ä¸Šä¼ 
      uses: actions/upload-artifact@v4
      with:
        name: vcpkg-export
        path: export/
  
  release:
    runs-on: ubuntu-latest
    needs: build-windows
    permissions: write-all

    steps:
      - name:  è¯»å–ä»“åº“å†…å®¹
        uses: actions/checkout@v4
        with:
          submodules: "false"
          fetch-depth: 0
          fetch-tags: true

      - name: è¯»å–åˆ†æ”¯æ–‡ä»¶
        id: getbranch
        shell: bash
        run: echo branch=$(git describe --tags --exact-match HEAD || echo nightly) >> $GITHUB_OUTPUT
      
      - name: Download export dir
        uses: actions/download-artifact@v4
        with:
          name: vcpkg-export
          path: house
    
      - name: ls
        run: ls
      
      - name: Zip
        run: |
          zip -r install.zip house/vcpkg-export
          mv install.zip house/
      - name: Update Nightly Release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.getbranch.outputs.branch }}
          name: 'Nightly Release'
          prerelease: true
          body: 'nightly release. This release is mainly for internal testing. Stable releases are published to pypi https://pypi.org/project/sapien/'
          files: |
            ./house/*.zip